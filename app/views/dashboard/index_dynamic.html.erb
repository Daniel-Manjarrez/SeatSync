<%
  # Tab selection logic
  current_tab = params[:tab] || 'overview'
%>

<div class="dashboard-container">
  <!-- Sidebar Navigation -->
  <div class="sidebar" id="sidebar">
    <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle Sidebar" onclick="toggleSidebar()">
      <svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect width="18" height="18" x="3" y="3" rx="2"/>
        <path d="M9 3v18"/>
        <path d="m14 9 3 3-3 3"/>
      </svg>
    </button>

    <div class="sidebar-header">
      <div class="logo-container">
        <div class="logo-icon">üçΩÔ∏è</div>
        <span class="logo-text">SeatSync</span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <%= link_to dashboard_path, class: 'nav-item active' do %>
        <span class="nav-content">
          <span class="nav-text">Restaurant Analytics</span>
        </span>
        <div class="nav-marquee">
          <div class="marquee-inner">
            <span>Restaurant Analytics</span>
            <span>Restaurant Analytics</span>
            <span>Restaurant Analytics</span>
            <span>Restaurant Analytics</span>
          </div>
        </div>
      <% end %>

      <%= link_to new_receipt_path, class: 'nav-item' do %>
        <span class="nav-content">
          <span class="nav-text">Upload Images</span>
        </span>
        <div class="nav-marquee">
          <div class="marquee-inner">
            <span>Upload Images</span>
            <span>Upload Images</span>
            <span>Upload Images</span>
            <span>Upload Images</span>
          </div>
        </div>
      <% end %>

      <%= link_to ingredients_path, class: 'nav-item' do %>
        <span class="nav-content">
          <span class="nav-text">Ingredients Dashboard</span>
        </span>
        <div class="nav-marquee">
          <div class="marquee-inner">
            <span>Ingredients Dashboard</span>
            <span>Ingredients Dashboard</span>
            <span>Ingredients Dashboard</span>
            <span>Ingredients Dashboard</span>
          </div>
        </div>
      <% end %>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <!-- Header with Growth Metrics -->
    <div class="dashboard-header">
      <div>
        <h1 class="dashboard-title">Restaurant Analytics</h1>
        <p class="dashboard-subtitle">Real-time performance metrics and insights</p>
      </div>
      <div class="growth-badges">
        <div class="growth-badge <%= @week_over_week_growth >= 0 ? 'positive' : 'negative' %>">
          <span class="growth-label">WoW</span>
          <span class="growth-value"><%= @week_over_week_growth >= 0 ? '+' : '' %><%= @week_over_week_growth %>%</span>
        </div>
        <div class="growth-badge <%= @month_over_month_growth >= 0 ? 'positive' : 'negative' %>">
          <span class="growth-label">MoM</span>
          <span class="growth-value"><%= @month_over_month_growth >= 0 ? '+' : '' %><%= @month_over_month_growth %>%</span>
        </div>
      </div>
    </div>

    <% if @total_orders == 0 %>
      <!-- Empty State -->
      <div class="empty-state" style="text-align: center; padding: 60px 20px; background: white; border-radius: 12px; margin: 20px 0;">
        <div style="font-size: 64px; margin-bottom: 20px;">üìä</div>
        <h2 style="color: #1a1a1a; margin-bottom: 12px;">No Receipt Data Yet</h2>
        <p style="color: #6b7280; margin-bottom: 24px; font-size: 16px;">
          Upload your first receipt to start seeing analytics and insights!
        </p>
        <%= link_to 'Upload Receipt', new_receipt_path, class: 'btn btn-primary', style: 'display: inline-block; padding: 12px 24px; background: #2563eb; color: white; text-decoration: none; border-radius: 8px; font-weight: 500;' %>
      </div>
    <% else %>
      <!-- Tab Navigation -->
      <div class="tab-navigation">
        <%= link_to 'Overview', dashboard_path(tab: 'overview'), class: "tab-btn #{current_tab == 'overview' ? 'active' : ''}" %>
        <%= link_to 'Revenue Analysis', dashboard_path(tab: 'revenue'), class: "tab-btn #{current_tab == 'revenue' ? 'active' : ''}" %>
        <%= link_to 'Menu Performance', dashboard_path(tab: 'menu'), class: "tab-btn #{current_tab == 'menu' ? 'active' : ''}" %>
        <%= link_to 'Timing & Operations', dashboard_path(tab: 'timing'), class: "tab-btn #{current_tab == 'timing' ? 'active' : ''}" %>
      </div>

      <!-- Tab Content -->
      <% if current_tab == 'overview' %>
      <!-- OVERVIEW TAB -->
      <div class="tab-content active">
        <!-- Top Metrics Cards -->
        <div class="metrics-row">
          <div class="metric-card">
            <div class="metric-content">
              <div class="metric-label">Total Orders</div>
              <div class="metric-value-container">
                <span class="metric-value"><%= @total_orders %></span>
                <span class="metric-unit">orders</span>
              </div>
            </div>
            <div class="metric-icon accent-emerald">üìä</div>
          </div>

          <div class="metric-card">
            <div class="metric-content">
              <div class="metric-label">Occupancy Rate</div>
              <div class="metric-value-container">
                <span class="metric-value"><%= @occupancy_rate %></span>
                <span class="metric-unit">%</span>
              </div>
            </div>
            <div class="metric-icon accent-emerald">ü™ë</div>
          </div>

          <div class="metric-card">
            <div class="metric-content">
              <div class="metric-label">Avg Order Size</div>
              <div class="metric-value-container">
                <span class="metric-value"><%= @average_order_size %></span>
                <span class="metric-unit">items</span>
              </div>
            </div>
            <div class="metric-icon accent-emerald">üõí</div>
          </div>

          <div class="metric-card">
            <div class="metric-content">
              <div class="metric-label">Avg Spend</div>
              <div class="metric-value-container">
                <span class="metric-value">$<%= @average_spend %></span>
                <span class="metric-unit">per order</span>
              </div>
            </div>
            <div class="metric-icon accent-emerald">üí∞</div>
          </div>
        </div>

        <!-- Charts Row -->
        <div class="charts-row">
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Daily Revenue Trend (Last 30 Days)</h3>
            </div>
            <div class="chart-wrapper" style="height: 300px;">
              <canvas id="dailyRevenueChart"></canvas>
            </div>
          </div>

          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Customer Timing - Orders by Hour</h3>
            </div>
            <div class="chart-wrapper" style="height: 300px;">
              <canvas id="ordersbyHourChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Second Row -->
        <div class="charts-row">
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Revenue by Day of Week</h3>
            </div>
            <div class="chart-wrapper" style="height: 300px;">
              <canvas id="revenueByDayChart"></canvas>
            </div>
          </div>

          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Price Point Distribution</h3>
            </div>
            <div class="chart-wrapper" style="height: 300px;">
              <canvas id="priceDistributionChart"></canvas>
            </div>
          </div>
        </div>
      </div>

    <% elsif current_tab == 'revenue' %>
      <!-- REVENUE ANALYSIS TAB -->
      <div class="tab-content active">
        <div class="charts-row-full">
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Monthly Revenue Trend</h3>
              <p class="chart-subtitle">Last 12 months - Showing growth pattern</p>
            </div>
            <div class="chart-wrapper" style="height: 400px;">
              <canvas id="monthlyRevenueChart"></canvas>
            </div>
          </div>
        </div>

        <div class="charts-row">
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Weekly Revenue Trend</h3>
              <p class="chart-subtitle">Last 8 weeks</p>
            </div>
            <div class="chart-wrapper" style="height: 300px;">
              <canvas id="weeklyRevenueChart"></canvas>
            </div>
          </div>

          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Revenue by Meal Period</h3>
            </div>
            <div class="chart-wrapper" style="height: 300px;">
              <canvas id="mealPeriodChart"></canvas>
            </div>
          </div>
        </div>

        <div class="charts-row">
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Revenue by Category</h3>
            </div>
            <div class="chart-wrapper" style="height: 300px;">
              <canvas id="categoryRevenueChart"></canvas>
            </div>
          </div>

          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Average Check by Time of Day</h3>
            </div>
            <div class="chart-wrapper" style="height: 300px;">
              <canvas id="avgCheckTimeChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Weekday vs Weekend Comparison -->
        <div class="comparison-cards">
          <div class="compare-card">
            <h4>Weekday Performance</h4>
            <div class="compare-stats">
              <div class="compare-stat">
                <span class="stat-label">Revenue</span>
                <span class="stat-value">$<%= number_with_delimiter(@weekday_revenue) %></span>
              </div>
              <div class="compare-stat">
                <span class="stat-label">Orders</span>
                <span class="stat-value"><%= @weekday_orders %></span>
              </div>
              <div class="compare-stat">
                <span class="stat-label">Avg per Order</span>
                <span class="stat-value">$<%= @weekday_orders > 0 ? safe_divide(@weekday_revenue, @weekday_orders) : '0.00' %></span>
              </div>
            </div>
          </div>

          <div class="compare-card">
            <h4>Weekend Performance</h4>
            <div class="compare-stats">
              <div class="compare-stat">
                <span class="stat-label">Revenue</span>
                <span class="stat-value">$<%= number_with_delimiter(@weekend_revenue) %></span>
              </div>
              <div class="compare-stat">
                <span class="stat-label">Orders</span>
                <span class="stat-value"><%= @weekend_orders %></span>
              </div>
              <div class="compare-stat">
                <span class="stat-label">Avg per Order</span>
                <span class="stat-value">$<%= @weekend_orders > 0 ? safe_divide(@weekend_revenue, @weekend_orders) : '0.00' %></span>
              </div>
            </div>
          </div>
        </div>
      </div>

    <% elsif current_tab == 'menu' %>
      <!-- MENU PERFORMANCE TAB -->
      <div class="tab-content active">
        <div class="charts-row">
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Top 10 Most Popular Items</h3>
              <p class="chart-subtitle">Order frequency</p>
            </div>
            <div class="chart-wrapper">
              <div class="two-column-list">
                <div class="column">
                  <% @most_popular_items.first(5).each_with_index do |item, i| %>
                    <div class="list-item">
                      <span class="item-rank"><%= i + 1 %>.</span>
                      <span class="item-name"><%= item[:name] %></span>
                      <span class="item-count"><%= item[:count] %></span>
                    </div>
                  <% end %>
                </div>
                <div class="column">
                  <% (@most_popular_items[5..9] || []).each_with_index do |item, i| %>
                    <div class="list-item">
                      <span class="item-rank"><%= i + 6 %>.</span>
                      <span class="item-name"><%= item[:name] %></span>
                      <span class="item-count"><%= item[:count] %></span>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          </div>

          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Bottom 10 Least Popular Items</h3>
              <p class="chart-subtitle">Consider removing</p>
            </div>
            <div class="chart-wrapper">
              <div class="two-column-list">
                <div class="column">
                  <% @least_popular_items.first(5).each_with_index do |item, i| %>
                    <div class="list-item unpopular">
                      <span class="item-rank"><%= i + 1 %>.</span>
                      <span class="item-name"><%= item[:name] %></span>
                      <span class="item-count"><%= item[:count] %></span>
                    </div>
                  <% end %>
                </div>
                <div class="column">
                  <% (@least_popular_items[5..9] || []).each_with_index do |item, i| %>
                    <div class="list-item unpopular">
                      <span class="item-rank"><%= i + 6 %>.</span>
                      <span class="item-name"><%= item[:name] %></span>
                      <span class="item-count"><%= item[:count] %></span>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Item Attachment Rate -->
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">Item Attachment Rate - Common Pairings</h3>
            <p class="chart-subtitle">Cross-selling opportunities</p>
          </div>
          <div class="attachment-table">
            <table>
              <thead>
                <tr>
                  <th>Item A</th>
                  <th>Item B</th>
                  <th>Attachment Rate</th>
                </tr>
              </thead>
              <tbody>
                <% if @item_attachments.any? %>
                  <% @item_attachments.each do |pair| %>
                    <tr>
                      <td><%= pair[:item_a] %></td>
                      <td><%= pair[:item_b] %></td>
                      <td>
                        <div class="rate-bar">
                          <div class="rate-fill" style="width: <%= pair[:rate] %>%"></div>
                          <span class="rate-text"><%= pair[:rate] %>%</span>
                        </div>
                      </td>
                    </tr>
                  <% end %>
                <% else %>
                  <tr>
                    <td colspan="3" style="text-align: center; color: #6b7280; padding: 20px;">
                      Not enough data to calculate attachment rates. Upload more receipts.
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Product Performance -->
        <div class="chart-card product-chart-card">
          <div class="chart-header">
            <h3 class="chart-title">Product Performance</h3>
            <p class="chart-subtitle">Top products by sales</p>
          </div>
          <div class="chart-wrapper" style="height: 400px;">
            <canvas id="productPerformanceChart"></canvas>
          </div>
        </div>
      </div>

    <% elsif current_tab == 'timing' %>
      <!-- TIMING & OPERATIONS TAB -->
      <div class="tab-content active">
        <div class="metrics-row-small">
          <div class="metric-card-small">
            <div class="metric-label">Avg Orders/Hour</div>
            <div class="metric-value-large"><%= @average_orders_per_hour %></div>
          </div>
          <div class="metric-card-small">
            <div class="metric-label">Time Between Orders</div>
            <div class="metric-value-large"><%= @time_between_orders %> min</div>
          </div>
          <div class="metric-card-small">
            <div class="metric-label">Avg Items/Order</div>
            <div class="metric-value-large"><%= @average_items_per_order %></div>
          </div>
        </div>

        <div class="charts-row-full">
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Order Frequency by 15-Minute Intervals</h3>
              <p class="chart-subtitle">Lunch rush (11 AM - 3 PM) - Identify peak times</p>
            </div>
            <div class="chart-wrapper" style="height: 400px;">
              <canvas id="fifteenMinIntervalsChart"></canvas>
            </div>
          </div>
        </div>

        <div class="charts-row">
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Hourly Order Distribution</h3>
            </div>
            <div class="chart-wrapper" style="height: 300px;">
              <canvas id="hourlyDistributionChart"></canvas>
            </div>
          </div>

          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Meal Period Breakdown</h3>
            </div>
            <div class="chart-wrapper" style="height: 300px;">
              <canvas id="mealPeriodBreakdownChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    <% end %>
    <% end %> <!-- End of @total_orders check -->
  </div>
</div>

<script>
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('collapsed');
  document.getElementById('mainContent').classList.toggle('expanded');
}

// Chart.js default configuration
Chart.defaults.color = '#94a3b8';
Chart.defaults.font.family = 'system-ui, -apple-system, sans-serif';
Chart.defaults.plugins.legend.display = false;

// Initialize charts after page load
document.addEventListener('DOMContentLoaded', function() {
  <% if @total_orders > 0 %>
    <% if current_tab == 'overview' %>
      // Daily Revenue Chart
      <% daily_labels = @daily_revenue.keys %>
      <% daily_values = @daily_revenue.values %>
      <% daily_max = daily_values.max || 100 %>
      new Chart(document.getElementById('dailyRevenueChart'), {
        type: 'line',
        data: <%= chart_data_json(daily_labels, daily_values, 'Revenue') %>,
        options: <%= line_chart_options('Revenue ($)', daily_max) %>
      });

      // Orders by Hour Chart
      <% hour_labels = @timing_data.keys %>
      <% hour_values = @timing_data.values %>
      <% hour_max = hour_values.max || 10 %>
      new Chart(document.getElementById('ordersbyHourChart'), {
        type: 'line',
        data: <%= chart_data_json(hour_labels, hour_values, 'Orders') %>,
        options: <%= line_chart_options('Orders', hour_max) %>
      });

      // Revenue by Day of Week
      <% day_labels = @revenue_by_day.keys %>
      <% day_values = @revenue_by_day.values %>
      <% day_max = day_values.max || 100 %>
      new Chart(document.getElementById('revenueByDayChart'), {
        type: 'bar',
        data: <%= bar_chart_data_json(day_labels, day_values, 'Revenue') %>,
        options: <%= bar_chart_options('Revenue ($)', day_max) %>
      });

      // Price Distribution Chart
      <% price_labels = @price_distribution.keys %>
      <% price_values = @price_distribution.values %>
      new Chart(document.getElementById('priceDistributionChart'), {
        type: 'doughnut',
        data: <%= pie_chart_data_json(price_labels, price_values) %>,
        options: <%= pie_chart_options %>
      });

    <% elsif current_tab == 'revenue' %>
      // Monthly Revenue Chart
      <% monthly_labels = @monthly_revenue.keys %>
      <% monthly_values = @monthly_revenue.values %>
      <% monthly_max = monthly_values.max || 100 %>
      new Chart(document.getElementById('monthlyRevenueChart'), {
        type: 'line',
        data: <%= chart_data_json(monthly_labels, monthly_values, 'Revenue') %>,
        options: <%= line_chart_options('Revenue ($)', monthly_max) %>
      });

      // Weekly Revenue Chart
      <% weekly_labels = @weekly_revenue.keys %>
      <% weekly_values = @weekly_revenue.values %>
      <% weekly_max = weekly_values.max || 100 %>
      new Chart(document.getElementById('weeklyRevenueChart'), {
        type: 'bar',
        data: <%= bar_chart_data_json(weekly_labels, weekly_values, 'Revenue') %>,
        options: <%= bar_chart_options('Revenue ($)', weekly_max) %>
      });

      // Meal Period Chart
      <% meal_labels = @revenue_by_meal_period.keys %>
      <% meal_values = @revenue_by_meal_period.values %>
      <% meal_max = meal_values.max || 100 %>
      new Chart(document.getElementById('mealPeriodChart'), {
        type: 'bar',
        data: <%= bar_chart_data_json(meal_labels, meal_values, 'Revenue') %>,
        options: <%= bar_chart_options('Revenue ($)', meal_max) %>
      });

      // Category Revenue Chart
      <% cat_labels = @revenue_by_category.keys %>
      <% cat_values = @revenue_by_category.values %>
      new Chart(document.getElementById('categoryRevenueChart'), {
        type: 'doughnut',
        data: <%= pie_chart_data_json(cat_labels, cat_values) %>,
        options: <%= pie_chart_options %>
      });

      // Average Check by Time
      <% check_labels = @avg_check_by_time.keys %>
      <% check_values = @avg_check_by_time.values %>
      <% check_max = check_values.max || 50 %>
      new Chart(document.getElementById('avgCheckTimeChart'), {
        type: 'line',
        data: <%= chart_data_json(check_labels, check_values, 'Avg Check') %>,
        options: <%= line_chart_options('Amount ($)', check_max) %>
      });

    <% elsif current_tab == 'menu' %>
      // Product Performance Chart
      <% prod_labels = @product_data.map { |p| p[:name] } %>
      <% prod_values = @product_data.map { |p| p[:amount] } %>
      <% prod_max = prod_values.max || 100 %>
      new Chart(document.getElementById('productPerformanceChart'), {
        type: 'bar',
        data: <%= bar_chart_data_json(prod_labels, prod_values, 'Revenue') %>,
        options: <%= bar_chart_options('Revenue ($)', prod_max) %>
      });

    <% elsif current_tab == 'timing' %>
      // 15-Minute Intervals Chart
      <% interval_labels = @fifteen_min_intervals.keys %>
      <% interval_values = @fifteen_min_intervals.values %>
      <% interval_max = interval_values.max || 10 %>
      new Chart(document.getElementById('fifteenMinIntervalsChart'), {
        type: 'bar',
        data: <%= bar_chart_data_json(interval_labels, interval_values, 'Orders') %>,
        options: <%= bar_chart_options('Orders', interval_max) %>
      });

      // Hourly Distribution Chart
      <% hourly_labels = @timing_data.keys %>
      <% hourly_values = @timing_data.values %>
      <% hourly_max = hourly_values.max || 10 %>
      new Chart(document.getElementById('hourlyDistributionChart'), {
        type: 'line',
        data: <%= chart_data_json(hourly_labels, hourly_values, 'Orders') %>,
        options: <%= line_chart_options('Orders', hourly_max) %>
      });

      // Meal Period Breakdown (pie chart)
      <% meal_breakdown_labels = @revenue_by_meal_period.keys %>
      <% meal_breakdown_values = @revenue_by_meal_period.values %>
      new Chart(document.getElementById('mealPeriodBreakdownChart'), {
        type: 'doughnut',
        data: <%= pie_chart_data_json(meal_breakdown_labels, meal_breakdown_values) %>,
        options: <%= pie_chart_options %>
      });
    <% end %>
  <% end %>
});
</script>
