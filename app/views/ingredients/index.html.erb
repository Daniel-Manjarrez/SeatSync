<div class="dashboard-container">
  <!-- Sidebar Navigation -->
  <div class="sidebar" id="sidebar">
    <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle Sidebar" onclick="toggleSidebar()">
      <svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect width="18" height="18" x="3" y="3" rx="2"/>
        <path d="M9 3v18"/>
        <path d="m14 9 3 3-3 3"/>
      </svg>
    </button>
    
    <div class="sidebar-header">
      <div class="logo-container">
        <div class="logo-icon">üçΩÔ∏è</div>
        <span class="logo-text">SeatSync</span>
      </div>
    </div>
    
    <nav class="sidebar-nav">
      <%= link_to dashboard_path, class: 'nav-item' do %>
        <span class="nav-content"><span class="nav-text">Restaurant Analytics</span></span>
        <div class="nav-marquee"><div class="marquee-inner"><span>Restaurant Analytics</span><span>Restaurant Analytics</span></div></div>
      <% end %>
      
      <%= link_to new_receipt_path, class: 'nav-item' do %>
        <span class="nav-content"><span class="nav-text">Upload Images</span></span>
        <div class="nav-marquee"><div class="marquee-inner"><span>Upload Images</span><span>Upload Images</span></div></div>
      <% end %>
      
      <%= link_to ingredients_path, class: 'nav-item active' do %>
        <span class="nav-content"><span class="nav-text">Ingredients Dashboard</span></span>
        <div class="nav-marquee"><div class="marquee-inner"><span>Ingredients Dashboard</span><span>Ingredients Dashboard</span></div></div>
      <% end %>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <div class="dashboard-header">
      <div>
        <h1 class="dashboard-title">Ingredients Dashboard</h1>
        <p class="dashboard-subtitle">Track ingredient usage across all menu items</p>
      </div>
      <div style="margin-left: auto; display: flex; align-items: center; gap: 0.75rem;">
        <button class="btn btn-primary" type="button" onclick="openAddRecipeModal()" style="padding: 0.5rem 0.9rem; background: linear-gradient(135deg, #06b6d4 0%, #0ea5e9 100%); color: white; border-radius: 8px; border: none; font-weight: 600;">Add Recipe</button>
      </div>
    </div>

    <!-- Recipes list (grid: 4 items per row) -->
    <div class="recipes-list" style="margin-bottom: 1.5rem;">
      <h3 style="color: #e2e8f0; margin-bottom: 0.5rem;">Current Recipes</h3>
      <% if @items.any? %>
        <div class="recipes-grid" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:0.75rem;">
          <% @items.each do |item| %>
            <div class="recipe-card" style="background:#071024; border:1px solid #1f2a44; padding:0.75rem; border-radius:8px; display:flex; flex-direction:column; min-height:100px;">
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; gap:0.75rem; align-items:center;">
                  <button type="button" onclick="toggleRecipeDetails(<%= item.id %>)" style="background:transparent; border:none; color:#94a3b8; font-size:1rem;">
                    <span id="chev-<%= item.id %>" class="chev" style="display:inline-block; transform:rotate(0deg); transition: transform 0.18s ease;">‚ñ∏</span>
                  </button>
                  <div>
                    <div style="color:#e2e8f0; font-weight:600;"><%= item.name %></div>
                    <div style="color:#94a3b8; font-size:0.9rem;"><%= item.category %> ‚Ä¢ $<%= number_with_precision(item.price, precision: 2) %></div>
                  </div>
                </div>
                <div style="display:flex; gap:0.5rem; align-items:center;">
                  <%= link_to 'Delete', item_path(item), method: :delete, data: { confirm: 'Delete this recipe? This cannot be undone if the item is not on any receipts.' }, class: 'btn', style: 'background:#ef4444; color:white; padding:0.35rem 0.6rem; border-radius:6px; text-decoration:none;' %>
                </div>
              </div>

              <div id="recipe-details-<%= item.id %>" style="display:none; margin-top:0.5rem;">
                <% if item.recipes.is_a?(Hash) && item.recipes.any? %>
                  <%= form_with url: item_path(item), method: :patch, local: true do |f| %>
                    <table style="width:100%; border-collapse: collapse;">
                      <thead>
                        <tr>
                          <th style="text-align:left; color:#94a3b8; padding-bottom:0.5rem;">Ingredient</th>
                          <th style="text-align:right; color:#94a3b8; padding-bottom:0.5rem;">Amount / serving</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% item.recipes.each do |ingredient_name, amount| %>
                          <tr>
                            <td style="padding:6px 0; color:#e2e8f0;">
                              <%= ingredient_name %>
                              <input type="hidden" name="recipes[][name]" value="<%= ingredient_name %>">
                            </td>
                            <td style="padding:6px 0; text-align:right; color:#10b981;">
                              <input type="number" name="recipes[][amount]" step="0.01" min="0" value="<%= amount %>" style="width:110px; padding:0.25rem; border-radius:6px; background:#071024; border:1px solid #1f2a44; color:#e2e8f0; text-align:right;" />
                              &nbsp;<%= (Ingredient.find_by(name: ingredient_name)&.unit || 'lbs') %>
                            </td>
                          </tr>
                        <% end %>
                      </tbody>
                    </table>
                    <div style="display:flex; justify-content:flex-end; gap:0.5rem; margin-top:0.5rem;">
                      <%= f.submit 'Save', style: 'background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding:0.35rem 0.6rem; border-radius:6px; border:none; font-weight:600;' %>
                    </div>
                  <% end %>
                <% else %>
                  <div style="color:#94a3b8;">No ingredients defined for this recipe.</div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div style="color:#94a3b8;">No recipes yet. Use Add Recipe to create menu items.</div>
      <% end %>
    </div>

    <% if @ingredient_usage.any? %>
      <div class="chart-card" style="margin-bottom: 2rem;">
        <div class="chart-header">
          <h3 class="chart-title">Ingredient Usage This Month</h3>
          <p class="chart-subtitle">Total consumption from <%= Date.today.beginning_of_month.strftime('%B %d') %> - <%= Date.today.strftime('%B %d, %Y') %></p>
        </div>

        <div class="ingredient-table" style="padding: 1.5rem;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 2px solid #334155;">
                <th style="padding: 12px; text-align: left; color: #94a3b8; font-size: 12px; text-transform: uppercase;">Ingredient</th>
                <th style="padding: 12px; text-align: right; color: #94a3b8; font-size: 12px; text-transform: uppercase;">Unit</th>
                <th style="padding: 12px; text-align: right; color: #94a3b8; font-size: 12px; text-transform: uppercase;">This Month</th>
                <th style="padding: 12px; text-align: right; color: #94a3b8; font-size: 12px; text-transform: uppercase;">Last Month</th>
                <th style="padding: 12px; text-align: right; color: #94a3b8; font-size: 12px; text-transform: uppercase;">Change</th>
              </tr>
            </thead>
            <tbody>
              <% @ingredient_usage.sort_by { |_, amount| -amount }.each do |ingredient_name, amount| %>
                <% ingredient = Ingredient.find_by(name: ingredient_name) %>
                <% last_month_amount = @last_month_usage[ingredient_name] || 0 %>
                <% change_percent = last_month_amount > 0 ? ((amount - last_month_amount) / last_month_amount * 100).round(1) : 0 %>
                <tr style="border-bottom: 1px solid #1e293b;">
                  <td style="padding: 16px; color: #e2e8f0; font-weight: 500;"><%= ingredient_name %></td>
                  <td style="padding: 16px; text-align: right; color: #94a3b8;"><%= ingredient&.unit || 'lbs' %></td>
                  <td style="padding: 16px; text-align: right; color: #10b981; font-weight: 600;"><%= number_with_precision(amount, precision: 2) %></td>
                  <td style="padding: 16px; text-align: right; color: #64748b;"><%= number_with_precision(last_month_amount, precision: 2) %></td>
                  <td style="padding: 16px; text-align: right;">
                    <% if change_percent > 0 %>
                      <span style="color: #10b981;">+<%= change_percent %>%</span>
                    <% elsif change_percent < 0 %>
                      <span style="color: #ef4444;"><%= change_percent %>%</span>
                    <% else %>
                      <span style="color: #64748b;">-</span>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>

      <div class="metrics-row" style="gap: 1.5rem;">
        <div class="metric-card">
          <div class="metric-content">
            <div class="metric-label">Total Ingredients</div>
            <div class="metric-value-container">
              <span class="metric-value"><%= @ingredients.count %></span>
              <span class="metric-unit">types</span>
            </div>
          </div>
          <div class="metric-icon accent-emerald">üì¶</div>
        </div>

        <div class="metric-card">
          <div class="metric-content">
            <div class="metric-label">Top Ingredient</div>
            <div class="metric-value-container">
              <span class="metric-value" style="font-size: 1.25rem;"><%= @ingredient_usage.max_by { |_, v| v }&.first || 'N/A' %></span>
            </div>
          </div>
          <div class="metric-icon accent-emerald">ü•á</div>
        </div>

        <div class="metric-card">
          <div class="metric-content">
            <div class="metric-label">Receipts This Month</div>
            <div class="metric-value-container">
              <span class="metric-value"><%= Receipt.where(receipt_date: Date.today.beginning_of_month..Date.today).count %></span>
              <span class="metric-unit">orders</span>
            </div>
          </div>
          <div class="metric-icon accent-emerald">üßæ</div>
        </div>
      </div>
    <% else %>
      <div class="chart-card" style="text-align: center; padding: 4rem 2rem;">
        <h3 style="color: #e2e8f0; font-size: 1.5rem; margin-bottom: 1rem;">No Data Available</h3>
        <p style="color: #94a3b8; margin-bottom: 2rem;">Upload receipts to start tracking ingredient usage</p>
        <%= link_to 'Upload Receipt', new_receipt_path, class: 'btn btn-primary', style: 'display: inline-block; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: 600;' %>
      </div>
    <% end %>
  </div>
</div>

<!-- Add Recipe Modal -->
<div id="addRecipeModal" style="display:none; position: fixed; inset: 0; background: rgba(2,6,23,0.6); z-index: 1000; align-items: center; justify-content: center;">
  <div style="background: #0f172a; width: 720px; max-width: 95%; margin: auto; border-radius: 10px; padding: 1.25rem; color: #e2e8f0;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 0.75rem;">
      <h3 style="margin:0;">Add New Recipe (Menu Item)</h3>
      <button type="button" onclick="closeAddRecipeModal()" style="background:transparent; border:none; color:#94a3b8; font-size:1.25rem;">‚úï</button>
    </div>

    <%= form_with url: items_path, local: true do |f| %>
      <div style="display: grid; grid-template-columns: 1fr 160px 160px; gap: 0.5rem; margin-bottom: 0.75rem;">
        <div>
          <label style="font-size: 0.9rem; color:#94a3b8;">Name</label>
          <%= f.text_field :name, required: true, style: 'width:100%; padding: 0.5rem; border-radius:6px; background:#071024; border:1px solid #1f2a44; color: #e2e8f0;' %>
        </div>
        <div>
          <label style="font-size: 0.9rem; color:#94a3b8;">Price</label>
          <%= f.number_field :price, step: 0.01, min: 0, required: true, style: 'width:100%; padding: 0.5rem; border-radius:6px; background:#071024; border:1px solid #1f2a44; color: #e2e8f0;' %>
        </div>
        <div>
          <label style="font-size: 0.9rem; color:#94a3b8;">Category</label>
          <%= f.select :category, Item::CATEGORIES, {}, style: 'width:100%; padding: 0.5rem; border-radius:6px; background:#071024; border:1px solid #1f2a44; color: #e2e8f0;' %>
        </div>
      </div>

      <div style="margin-bottom: 0.5rem;">
        <label style="font-size: 0.9rem; color:#94a3b8;">Ingredients (name & amount per serving)</label>
        <div id="ingredientsContainer" style="margin-top: 0.5rem; display:flex; flex-direction:column; gap:0.5rem;"></div>
        <div style="margin-top:0.5rem;">
          <button type="button" onclick="addIngredientRow()" style="background:#0ea5e9; color:white; border:none; padding:0.4rem 0.7rem; border-radius:6px; font-weight:600;">+ Add Ingredient</button>
        </div>
      </div>

      <div style="display:flex; justify-content:flex-end; gap:0.5rem; margin-top: 0.75rem;">
        <button type="button" onclick="closeAddRecipeModal()" style="background:transparent; color:#94a3b8; border:1px solid #1f2a44; padding:0.45rem 0.85rem; border-radius:6px;">Cancel</button>
        <%= f.submit 'Create Recipe', style: 'background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding:0.45rem 0.85rem; border-radius:6px; border:none; font-weight:600;' %>
      </div>
    <% end %>
  </div>
</div>

<script>
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('collapsed');
  document.getElementById('mainContent').classList.toggle('expanded');
}

function openAddRecipeModal() {
  document.getElementById('addRecipeModal').style.display = 'flex';
  // Ensure at least one ingredient row
  if (document.querySelectorAll('#ingredientsContainer .ingredient-row').length === 0) {
    addIngredientRow();
  }
}

function closeAddRecipeModal() {
  document.getElementById('addRecipeModal').style.display = 'none';
  // clear rows
  const container = document.getElementById('ingredientsContainer');
  if (container) container.innerHTML = '';
}

function addIngredientRow(name = '', amount = '') {
  const container = document.getElementById('ingredientsContainer');
  if (!container) return;

  const row = document.createElement('div');
  row.className = 'ingredient-row';
  row.style.display = 'grid';
  row.style.gridTemplateColumns = '1fr 120px 40px';
  row.style.gap = '0.5rem';

  row.innerHTML = `
    <input type="text" name="ingredients[][name]" value="${escapeHtml(name)}" placeholder="Ingredient name" required style="padding:0.45rem; border-radius:6px; background:#071024; border:1px solid #1f2a44; color:#e2e8f0;" />
    <input type="number" step="0.01" min="0" name="ingredients[][amount]" value="${escapeHtml(amount)}" placeholder="Amount" required style="padding:0.45rem; border-radius:6px; background:#071024; border:1px solid #1f2a44; color:#e2e8f0;" />
    <button type="button" onclick="this.parentNode.remove()" title="Remove" style="background:#ef4444; color:white; border:none; border-radius:6px;">‚àí</button>
  `;

  container.appendChild(row);
}

function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/[&<>"'`]/g, function (s) {
    return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;",'`':'&#96;'})[s];
  });
}

function toggleRecipeDetails(id) {
  const el = document.getElementById('recipe-details-' + id);
  if (!el) return;
  const isHidden = (el.style.display === 'none' || el.style.display === '');
  el.style.display = isHidden ? 'block' : 'none';
  const chev = document.getElementById('chev-' + id);
  if (chev) {
    if (isHidden) chev.style.transform = 'rotate(90deg)'; else chev.style.transform = 'rotate(0deg)';
  }
}
</script>
